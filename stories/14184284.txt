Watch the 2 minutes exploit video where we manually tweet as if we were Charles Darwin, and get his passwordÂ (thanks to the default password manager of Microsoft Edge). If you are out of time, watch the 1 minute video where we do the same thing, automatically.

Charles Darwin is an example, this Microsoft Edge vulnerability allows the attacker to tweetÂ or do anything (password anyone?) fromÂ many websites on behalf of the logged user.

We are going to explore yet another SOP bypass on Microsoft Edge, but in this case abusing of the data/meta tags plus the fact that domainless pages have free access to domained ones.

If this is your first time here, I suggest you reading these two SOP bypasses first:Â Adventures in a Domainless World (Edge) andÂ More Adventures in a Domainless World (IE). The following post is based on the same idea, just a new technique.

Letâ€™s quickly refresh on this important concept: about:blank pages have always the domain of theirÂ referrer, meaning that an about:blank from a twitterâ€™s iframe canâ€™t access to a googleâ€™s blank. Even if the address matches between them (about:blank), the document.domain is different.

In the past, we were able to create about:blanks without domains, or domainless about:blanks. Those ones have the power to access every about:blank regardless of its domain. For example, letâ€™s say we have a domainless blank on the main page rendering an iframe pointing to twitter and another one to google. Those iframes have blank sub-iframes inside, and their domains are like their parents: twitter and google. In a case like this, the top windowÂ has access to the sub-iframes, completely bypassing the SOP.

The above scenario above worked perfectly well, but Microsoft patched itÂ three months ago using a very cleverÂ trick: domainless blanks are not really domainless anymore, they are always set with a random GUID as their domain, like this: {53394a4f-8c04-46ab-94af-3ab86ffcfd4c}.Â And thereâ€™s something even more interesting (hat tip to Edge Developers): the domain will look as if it were blank/empty, but it is not. In other words, Edge will hide the GUID and return empty, but internally, it is stillÂ a GUID.

Letâ€™s experiment! Open Edge with DevTools enabledÂ (F12) and type about:blank into the address bar. This used to create a domainless blank and it still looks as if nothing has changed, but Edge is performing a trick for us. Appreciate its magic for a second please, we will have plenty of time to break theÂ spell anyway.

As we can see, DevTools thinks we areÂ on an emptyÂ domain, but it is not.

If even DevTools is being fooled, howÂ canÂ we see whatâ€™s really happening here? Easier than expected, just try to load anything with a relative path, or change the location of this window, or even a document.write will reveal the trick. Letâ€™s use a location.href = 1 and see what happens.

Our previous technique to create domainless blanksÂ has been patched. We were setting a data-uri on the main (top) window with the help of a Flash/GetURL. But the trick was patched and even worse, weÂ canâ€™t automatically run Flash anymore! In Windows Creators Update, EdgeÂ asks for permission to runÂ Flash.

The PoCs from previous posts look ugly now! Kudos to the Edge team for reducing the attack surface here.

Our data-uri trick against the top does not work anymore, so how can we overcome this?Â First of all, I started playing against an iframe instead of the top, because as weâ€™ve seen in the past, Edge does not like data-uris in the main window.

But setting a data-uri as the location of an iframe works well. However, this is not a bug, the iframe domain is isolated from the top.

As weâ€™ve seen in the reader mode SOP bypass, the data-uri â€œisolatedâ€ restriction is trivial to bypass (just a self document.write and we can access the parent), but we donâ€™t want that now.Â Accessing the top makes no sense right now, what we want is a way to get a domainless blank. For that, we will need a triple-combo: data-meta-data. That will make Edge gently give us back what it took from us!

To be concrete, we will set the location of an iframe with a data uri that renders a meta refresh which redirectsÂ to another data uri. Thatâ€™s the moment where you, I, and even Edge get lost ğŸ™‚

Letâ€™s build a URL that converts a regular (domained) iframe into a domainless one. It is easier for me if I repeat this inÂ my mind â€œdata-meta-dataâ€, because in reality, thatâ€™s all.

I know it is not as beautifulÂ as E=mc2, but our trick could have been used to steal Einsteinâ€™s credentials, email, paypal account and even tweet something on his name. Letâ€™s first test if what weâ€™ve learned until this point really works. We will play with bing.com which is easy because it has an inner blank iframe and it does not use XFO.

We will create a webpage with two iframes: one with bing.com and one domainless. From the domainless we will execute code inside bingâ€™s inner blank iframe. Bing images Â is perfect for our needs. Let me open Chrome for a second and show you what I mean.

This is great. Now we will frame this page and inject code into the blank iframe with the help of our domainless data-meta-data. But thereâ€™s something that I didnâ€™t say, bug hunter. Do you remember the naming problem that we had with nature.com inÂ our original domainless SOP? If not, let me give you a very quick refresh.

At this point, our domainless iframeÂ is able to access bingâ€™s blank, but,Â the access mechanismÂ is extremely important. We canâ€™t justÂ access the DOM straight, weÂ must use the window.open method. In other words, if bing is in the first iframe of the main page, weÂ wonâ€™t be able to access its inner iframe this way:

In fact, we canâ€™t even do this

So, how can we do it? Very easy, a window open with a javascript urlÂ and the name of the iframe. If bingâ€™s inner iframe name were â€œINNER_IFRAMEâ€œ, the following code would work perfectly well:

But damn it!Â This nested iframe in Bing doesnâ€™t have a name! Bug hunter, donâ€™t panic. We can either request the Bing team to set a name for us, ğŸ™‚ or, we canÂ keep pushing. Better to keep pushing!

We canâ€™t set the name of an iframe that we donâ€™t own, unless it is in the same domain as we are. We are going to render a bing iframe that has a blank one inside. The outer iframe is on the different domain, but the tag itself (the element, the object) is in our domain, so we can set any name we want.

But the inner iframeÂ is rendered by bing, and even if itâ€™s blank, its domain is still bing.com. The only way to change its name is to first set its locationÂ to one that we can access, and only then change its name. Now, if we change the location of the about:blank it will be like shooting in the foot, because we need to be be bing.com so we can later access with the domainless blank.

Remember: our goal is to access from a domainless blank to a domained one. If we set the domain to match ours, then it makes no sense to access it! So hereâ€™s what we will do: we will set the location, change the iframe name and then,Â restore the location back in such a way that it will keep the original domain. Sounds complicated?

Thatâ€™s it.Â Now theÂ inner-iframe has a nameÂ and its domain is restored to bing.com!Â This is code:

Let me give you the good news: we donâ€™t really need sites with â€œabout:blankâ€ iframes becauseÂ we can always do as we did above. In other words, it does not matter if bingâ€™s inner iframe was about:blank on not because we ended up setting it as blank with its original domain! I donâ€™t know how you feel bug hunter, but I feel exactly like this.

The doors are open for us! We canÂ finally runÂ the window.open fromÂ our data-meta-data iframe:

One important thing regarding the PoC, bug hunter: in the sample above we are using an http (insecure) connection because in https the meta refresh to data is blocked so it never redirects to the final data uri. Edge incorrectly thinksÂ that the redirection is insecure. However, this can be easily bypassed by using a document.write. So instead of a data-meta-data it should be document.write(meta-data). Makes sense?

We are not using it in the PoC above, because when making the demo interactive (making you press buttons to run it) Edge crashes (non-exploitable ) a third of the times. So, Iâ€™ve chosen to use a guided and reliable PoC in http vs https automatic. But either way, as we will see below it does not really matter: our insecure domainless page is capable of accessing secure pages. Letâ€™s build a real case.

It is the time to build an attack, bug hunter. Join me into the time machine where we can fly to the past, bringing computers and Internet to the geniuses that preceded us. Charles Darwin is thinking about how species change over time, while Alfred Wallace is having similar ideas. Charles is aware of hackers so he uses his computer in paranoid mode: he never opens a link in using the same browser windowÂ where he has his gmail, twitter, and personal documents.

Take a look, bug hunter. He is opening a new InPrivate window from the task bar!

He is in good mood, to the point that he opens another tabÂ with his Twitter account, and teases Alfred Wallace about who will tweet first.

The response from WallaceÂ came a few hours later, and it included a link with evidence supporting his claims. But remember, Charles did not trust anyone so he copied the link in order to paste it into a newÂ window, away from the one where he had his personal dataÂ (gmail, twitter).

What can go wrong? Everything! Twitter has several iframes, just like most sites in the world. In fact, it has two blank iframes with names, so this should be easier than Bing! But before going back to our story ğŸ™‚ letâ€™s enumerate twitterâ€™s iframes using DevTools to find a good candidate. Iâ€™m opening a different window here, nothing to do with Charles session.

Excellent! dm-post-iframe looks good, so we have all we need to take over Charlieâ€™s account.

Charles opened a new inPrivate window and loaded the URL that Wallace sent him. What he didnâ€™t know was that browser windows, even inPrivate, can communicate with each other. So, what will happen if we execute the code below in our domainlessÂ iframe?

You are totally right. We have Charles Darwin cookies.

Keep in mind that we donâ€™t really need the InPrivate windows. The example above tries to illustrate a paranoid scenario, but normally things are even easier because people click on links without doing all the work that Charles did to prevent the attack. Also, consider that attackers useÂ malvertising, deploying their bad bits inside cheap banners from popularÂ sites. If an attacker is hosted inside a Yahoo banner and the user is logged in into her Twitter account, she will be pwned with no interactions, at all.

Letâ€™s build a better PoC.Â Instead of reading his cookies, we will tweet on his name and even try to grab his password. Keep in mind that most users (like Charlie) use password managers that auto-fill their passwords. Edge password manager is no different, so, if CharlesÂ has saved his password, we will get it. Itâ€™s not hard, just force him a log out and the log-in page will be automatically loaded, with all his data (username and password) server to us in a silver player. In fact, in this case the form is hidden unless the user interacts, but Edge is filling it anyway so we donâ€™t even have to make the form visible.

Before running the PoC, consider that it isÂ your account the one that will be exposed, not Charles. Nothing is being sent to the network but if thereâ€™s somebody behind you, she will see your password in aÂ regular alert dialog. Watch out!

Can we use this in sites without about:blank iframes?Â  Of course! We can even do it in sites that donâ€™t have iframes at all. Please, read this post where we inject an iframe on a different origin. Same here on Internet Explorer.

Is it possible to do the same thing, in Facebook?Â I donâ€™t have a facebook account, soÂ I did not test. But a SOP bypass is capable of accessing every single domain in the planet. It could be a little bit harder to exploit, but impossible? Remember the mantra of theÂ offensive-security guys: try harder.

Does this work in other browsers?Â I did not try, but obviously not.Â UXSS/SOP bypasses tend to be particular to each browser.

The exploit code is easy. PleaseÂ get it and take a look, but if you have questions, ask! I stop here, bug hunter, otherwise this blog will be renamed to brokenmarriage.com ğŸ™‚ Itâ€™s late night in Buenos Aires, time to be with my wife!|||

